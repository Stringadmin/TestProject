<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OopsHub - 文本生图</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1E40AF',
            secondary: '#166534',
            accent: '#7C3AED',
            dark: '#1E293B',
            light: '#F8FAFC'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .gradient-primary {
        background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 100%);
      }
      .gradient-hover {
        background: linear-gradient(135deg, #1E3A8A 0%, #2563EB 100%);
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .input-focus {
        @apply focus:ring-2 focus:ring-primary/30 focus:border-primary focus:outline-none;
      }
      .card-effect {
        @apply bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen font-inter">
  <!-- 导航栏 -->
  <nav class="bg-white/90 backdrop-blur-sm border-b sticky top-0 z-50 transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <a href="index.html" class="flex items-center space-x-2 group">
          <i class="fa-solid fa-building text-primary text-2xl group-hover:scale-105 transition-transform"></i>
          <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-accent">OopsHub</span>
        </a>
        <div class="flex items-center space-x-1 md:space-x-4 text-sm font-medium">
          <a href="#" class="px-3 py-2 rounded-md text-primary bg-primary/10 border-b-2 border-primary transition-all">
            <i class="fa-solid fa-pen-to-square mr-1.5"></i>文本生图
          </a>
          <a href="test.html" class="px-3 py-2 rounded-md text-gray-600 hover:text-primary hover:bg-primary/5 transition-all">
            <i class="fa-solid fa-sliders mr-1.5"></i>更多功能
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- 主内容区 -->
  <section class="py-12 md:py-20">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- 标题区域 -->
      <div class="text-center mb-10 md:mb-12">
        <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-gray-900 mb-3 text-shadow">文本生图</h1>
        <p class="text-gray-600 max-w-xl mx-auto text-[clamp(1rem,2vw,1.125rem)]">
          输入建筑描述，AI将为您生成高清设计效果图，支持多种风格与场景
        </p>
      </div>

      <!-- 输入卡片 -->
      <div class="card-effect p-6 md:p-8 space-y-6">
        <!-- 提示词输入 -->
        <div>
          <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
            <i class="fa-solid fa-lightbulb text-primary mr-2"></i>设计描述
            <span class="text-gray-500 text-xs ml-2">(越详细，效果越精准)</span>
          </label>
          <textarea 
            id="prompt" 
            rows="4" 
            class="w-full px-4 py-3.5 border border-gray-200 rounded-xl shadow-sm input-focus transition-all resize-none"
            placeholder="例如：现代极简风格别墅，白色混凝土外墙，大面积落地玻璃，带无边际泳池，周围有绿植环绕，蓝天白云背景，黄昏光线"
          ></textarea>
        </div>

        <!-- 提示词示例 -->
        <div class="pt-2">
          <p class="text-xs text-gray-500 mb-2">推荐示例：</p>
          <div class="flex flex-wrap gap-2">
            <span class="text-xs px-2.5 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 cursor-pointer transition-colors example-prompt">
              新中式庭院，青瓦白墙，假山流水
            </span>
            <span class="text-xs px-2.5 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 cursor-pointer transition-colors example-prompt">
              工业风办公楼，裸露钢结构，玻璃幕墙
            </span>
            <span class="text-xs px-2.5 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 cursor-pointer transition-colors example-prompt">
              北欧风小屋，尖顶，木质外墙，雪景
            </span>
          </div>
        </div>

        <!-- 生成按钮 -->
        <button 
          id="gen" 
          class="w-full gradient-primary text-white py-3.5 rounded-xl font-medium shadow-md hover:shadow-lg hover:gradient-hover transform hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center space-x-2 group"
        >
          <span>立即生成设计图</span>
          <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
        </button>
        <!-- 测试按钮 -->
        <button id="testBtn" class="mt-3 w-full bg-green-600 text-white py-3.5 rounded-xl font-medium shadow-md hover:shadow-lg hover:bg-green-700 transform hover:-translate-y-0.5 transition-all duration-300">
          测试生成请求
        </button>

        <!-- 工作流信息和连接状态 -->
        <div class="text-xs text-gray-500 flex items-center justify-center pt-1 gap-6">
          <div class="flex items-center">
            <i class="fa-solid fa-cogs mr-1.5"></i>
            当前使用工作流：<span class="text-primary font-medium ml-1">test.json</span>
          </div>
          <div class="flex items-center" id="comfyui-status">
            <i class="fa-solid fa-server mr-1.5"></i>
            <span>ComfyUI 连接状态: <span class="font-medium" id="status-text">检查中...</span></span>
          </div>
        </div>
      </div>

      <!-- 生成结果区域 -->
      <div id="box" class="mt-8 opacity-0 scale-95 transition-all duration-500">
        <div class="card-effect p-1 md:p-2 overflow-hidden">
          <div class="relative">
            <!-- 加载状态占位符 -->
            <div id="loading-placeholder" class="hidden absolute inset-0 bg-gray-100 rounded-xl flex items-center justify-center">
              <div class="flex flex-col items-center">
                <div class="w-12 h-12 border-4 border-primary/20 border-t-primary rounded-full animate-spin mb-3"></div>
                <p class="text-gray-500 text-sm">正在生成设计图...</p>
              </div>
            </div>
            
            <!-- 生成的图片 -->
            <img 
              id="res" 
              class="rounded-xl w-full h-auto shadow-inner" 
              alt="生成结果"
              loading="lazy"
            >
          </div>
          
          <!-- 图片操作按钮 -->
          <div class="flex justify-center gap-3 mt-4 pb-2">
            <button class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
              <i class="fa-solid fa-download mr-1.5"></i>保存
            </button>
            <button class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
              <i class="fa-solid fa-refresh mr-1.5"></i>重新生成
            </button>
            <button class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
              <i class="fa-solid fa-share-alt mr-1.5"></i>分享
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- 页脚 -->
  <footer class="mt-16 py-6 border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
      <p>© 2023 OopsHub 智能建筑可视化工具 | 设计更高效，创意更自由</p>
    </div>
  </footer>

  <script>
    // API基础路径 - 在本地开发环境中使用根路径
    const genBtn = document.getElementById('gen');
    const promptInput = document.getElementById('prompt');
    const resultBox = document.getElementById('box');
    const resultImg = document.getElementById('res');
    const loadingPlaceholder = document.getElementById('loading-placeholder');
    const examplePrompts = document.querySelectorAll('.example-prompt');
    const statusText = document.getElementById('status-text');
    
    // 检查ComfyUI连接状态并显示
    async function checkComfyUIConnection() {
      console.log('开始检查ComfyUI连接状态...');
      try {
        // 使用AbortController实现超时控制
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          console.log('连接检查超时，取消请求');
          controller.abort();
        }, 10000); // 进一步延长超时时间
        
        console.log('发送GET请求到: /comfyui/status');
        const response = await fetch('/comfyui/status', {
          method: 'GET',
          signal: controller.signal,
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        clearTimeout(timeoutId);
        console.log(`连接状态请求完成，状态码: ${response.status}`);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('连接状态响应数据:', data);
        
        if (data.connected) {
          statusText.textContent = '已连接';
          statusText.className = 'font-medium text-green-600';
        } else {
          statusText.textContent = '未连接';
          statusText.className = 'font-medium text-red-600';
        }
      } catch (error) {
        console.error('检查ComfyUI连接失败详细信息:', {
          message: error.message,
          name: error.name,
          stack: error.stack
        });
        // 即使连接检查失败，也要给用户一个积极的状态，让他们可以尝试生成图像
        statusText.textContent = '可尝试生成';
        statusText.className = 'font-medium text-blue-600';
      }
    }
    
    // 页面加载时立即检查连接状态
    checkComfyUIConnection();
    // 每30秒自动更新连接状态
    setInterval(checkComfyUIConnection, 30000);

    // 示例提示词点击填充
    examplePrompts.forEach(example => {
      example.addEventListener('click', () => {
        promptInput.value = example.textContent.trim();
        promptInput.focus();
      });
    });

    // 全局错误监听
      window.addEventListener('error', (event) => {
        console.error('全局未捕获错误:', {
          message: event.message,
          filename: event.filename,
          lineno: event.lineno,
          colno: event.colno,
          error: event.error
        });
      });
      
      window.addEventListener('unhandledrejection', (event) => {
        console.error('全局未处理Promise拒绝:', {
          reason: event.reason
        });
      });
      
      // 测试按钮事件处理函数 - 极简版本
      const testBtn = document.getElementById('testBtn');
      console.log('测试按钮DOM元素:', testBtn);
      
      if (testBtn) {
        testBtn.addEventListener('click', async () => {
          console.log('===== 测试按钮被点击！执行极简请求测试 =====');
          
          try {
            // 直接发送POST请求到后端
            const testPrompt = '测试图像生成';
            const requestData = {
              prompt: testPrompt,
              workflow: 'test', // 改为workflow，与后端控制器参数名称匹配
              workflowPath: 'comfyui_workflows/test.json'
            };
            
            console.log('发送测试请求数据:', requestData);
            
            const response = await fetch('/comfyui/submit', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(requestData)
            });
            
            console.log('测试请求响应状态:', response.status);
            
            const data = await response.json();
            console.log('测试请求响应数据:', data);
            
            alert(`测试请求结果:\n状态码: ${response.status}\n成功: ${data.success || false}\npromptId: ${data.data?.promptId || '未获取'}`);
          } catch (error) {
            console.error('测试请求失败:', error);
            alert('测试请求失败: ' + error.message);
          }
        });
      } else {
        console.error('测试按钮元素未找到！');
      }
    
    console.log('生成按钮DOM元素:', genBtn);
    if (!genBtn) {
      console.error('生成按钮元素未找到！');
    } else {
      console.log('生成按钮元素找到，准备绑定事件监听器');
    }
    
    // 生成按钮点击事件
    console.log('绑定生成按钮点击事件');
    genBtn.addEventListener('click', async (event) => {
      event.preventDefault();
      event.stopPropagation();
      console.log('生成按钮点击事件触发！时间戳:', Date.now());
      console.log('=== 生成按钮被点击！开始处理图像生成请求 ===');
      
      // 立即显示加载状态
      genBtn.disabled = true;
      genBtn.innerHTML = '<div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div>';
      
      const prompt = promptInput.value.trim();
      console.log(`用户输入的提示词: "${prompt}"`);
      
      if (!prompt) {
        console.log('提示词为空，显示抖动动画');
        // 提示词为空时的微动效提醒
        promptInput.classList.add('border-red-300');
        promptInput.classList.add('animate-shake');
        setTimeout(() => {
          promptInput.classList.remove('border-red-300', 'animate-shake');
          genBtn.disabled = false;
          genBtn.innerHTML = '生成图像';
        }, 1000);
        return;
      }
      
      console.log('提示词有效，准备提交图像生成任务');
      
      // 显示结果区域
      resultBox.classList.remove('hidden');
      resultBox.classList.add('opacity-0', 'scale-95');
      loadingPlaceholder.classList.remove('hidden');
      resultImg.classList.add('hidden');

      try {
        console.log('=== 进入生成函数主要逻辑 ===');
        // 简化超时控制
        console.log('创建超时控制器');
        const controller = new AbortController();
        const timeoutId = setTimeout(() => {
          console.log('客户端120秒超时，中止请求');
          controller.abort();
        }, 120000);

        // Step1: 提交任务，获取 promptId（短请求）
        console.log('准备提交图像生成任务请求...');
        const requestData = {
          prompt,
          workflow: 'test',
          workflowPath: 'comfyui_workflows/test.json'
        };
        console.log('请求数据:', requestData);
        
        const submitUrl = '/comfyui/submit';
        console.log(`发送POST请求到: ${submitUrl}`);
        
        let submitData = null;
        try {
          console.log('构建fetch请求配置...');
          const fetchOptions = {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData),
            signal: controller.signal
          };
          console.log('fetch请求配置:', fetchOptions);
          
          console.log('开始发送fetch请求...');
          console.log('fetch API是否可用:', typeof fetch === 'function');
          
          const submitRes = await fetch(submitUrl, fetchOptions);
          
          console.log(`请求完成，状态码: ${submitRes.status}, 状态文本: ${submitRes.statusText}`);
          console.log('使用工作流: comfyui_workflows/test.json');
          
          // 清除超时定时器
          clearTimeout(timeoutId);
          console.log('超时定时器已清除');
          
          try {
            console.log('开始解析JSON响应...');
            submitData = await submitRes.json();
            console.log('响应数据:', submitData);
          } catch (jsonError) {
            console.error('解析JSON响应失败:', { name: jsonError.name, message: jsonError.message });
            throw new Error(`解析响应失败: ${jsonError.message}`);
          }
          
          if (!submitRes.ok) {
            console.error('HTTP错误:', submitRes.status, submitRes.statusText);
            throw new Error(submitData?.message || `HTTP错误: ${submitRes.status}`);
          }
          
          if (!submitData || !submitData.success || !submitData.data?.promptId) {
            console.error('业务错误:', submitData);
            throw new Error(submitData?.message || '提交生成任务失败或缺少必要的promptId');
          }
          
          console.log('任务提交成功，获取到promptId:', submitData.data.promptId);
         } catch (requestError) {
           console.error('提交请求失败:', { 
             name: requestError.name, 
             message: requestError.message,
             isAbortError: requestError.name === 'AbortError'
           });
           // 清除超时定时器
           clearTimeout(timeoutId);
           throw requestError;
         }
         
         if (!submitData || !submitData.data || !submitData.data.promptId) {
           console.error('严重错误: submitData或promptId未定义');
           throw new Error('内部错误: 无法获取任务ID');
         }
         
         const promptId = submitData.data.promptId;
         console.log('准备开始轮询结果，promptId:', promptId);

        // Step2: 前端轮询查询结果（每2秒一次，最多120秒）
          const startedAt = Date.now();
          const POLL_INTERVAL = 2000;
          const MAX_DURATION = 120000; // 2分钟客户端等待上限
          let ready = false;
          let pollCount = 0;
          
          console.log(`开始轮询查询结果，promptId: ${promptId}`);
          
          while (!ready && Date.now() - startedAt < MAX_DURATION) {
            pollCount++;
            console.log(`轮询 ${pollCount} 次，已等待 ${Math.floor((Date.now() - startedAt)/1000)} 秒`);
            
            await new Promise(r => setTimeout(r, POLL_INTERVAL));
            
            try {
              const rController = new AbortController();
              const rTimeout = setTimeout(() => rController.abort(), 10000);
              const resultUrl = `/comfyui/result?promptId=${encodeURIComponent(promptId)}`;
              console.log(`发起结果查询请求: ${resultUrl}`);
              
              const resultRes = await fetch(resultUrl, {
                method: 'GET',
                signal: rController.signal
              });
              
              clearTimeout(rTimeout);
              console.log(`结果查询响应状态: ${resultRes.status}`);
              
              if (!resultRes.ok) {
                console.log(`查询失败，状态码: ${resultRes.status}, 继续轮询...`);
                continue;
              }
              
              const resultData = await resultRes.json();
              console.log(`查询结果数据结构:`, {
                success: resultData.success,
                dataExists: !!resultData.data,
                isReady: resultData.data?.ready,
                hasImages: resultData.data?.images?.length > 0,
                imageCount: resultData.data?.images?.length || 0
              });
              
              if (resultData.success && resultData.data?.ready && resultData.data.images?.length) {
                ready = true;
                console.log('检测到生成完成的图像，准备显示');
                
                const imageInfo = resultData.data.images[0];
                const imgUrl = imageInfo.url;
                
                console.log('图像生成成功，详细信息:', {
                  url: imgUrl,
                  filename: imageInfo.filename,
                  subfolder: imageInfo.subfolder,
                  type: imageInfo.type,
                  isProxyUrl: imgUrl.includes('/comfyui/image-proxy')
                });
                
                // 优化：只使用一个图像对象进行预加载和最终显示
                console.log('创建图像对象进行预加载...');
                const preloadImg = new Image();
                
                // 设置图像加载超时处理
                const timeoutId = setTimeout(() => {
                  console.error('图像加载超时');
                  alert('图像加载超时，请刷新页面重试');
                  loadingPlaceholder.classList.add('hidden');
                }, 120000); // 2分钟超时
                
                preloadImg.onload = () => {
                  clearTimeout(timeoutId);
                  console.log('图像预加载成功！现在设置到显示元素');
                  // 预加载成功后，再设置给实际显示的元素
                  resultImg.src = imgUrl;
                  loadingPlaceholder.classList.add('hidden');
                  resultBox.classList.remove('hidden');
                };
                
                preloadImg.onerror = (error) => {
                  clearTimeout(timeoutId);
                  console.error('图像预加载失败详细信息:', {
                    message: error.message,
                    type: error.type,
                    target: error.target?.src
                  });
                  alert('图像预加载失败，请检查网络连接或刷新页面重试');
                  loadingPlaceholder.classList.add('hidden');
                };
                
                // 开始加载图像
                preloadImg.src = imgUrl;
                
                // 添加图像错误处理
                resultImg.onerror = (error) => {
                  console.error('图像加载失败详细信息:', {
                    message: error.message,
                    type: error.type,
                    target: error.target?.src,
                    currentSrc: resultImg.currentSrc
                  });
                  alert('图像加载失败，请检查网络连接或刷新页面重试');
                  loadingPlaceholder.classList.add('hidden');
                };
                
                resultImg.src = imgUrl;
                console.log('图像URL已设置，等待加载完成...');
                
                resultImg.onload = () => {
                  console.log('图像加载成功！图像尺寸:', {
                    width: resultImg.width,
                    height: resultImg.height
                  });
                  loadingPlaceholder.classList.add('hidden');
                  resultImg.classList.remove('hidden');
                  setTimeout(() => {
                    resultBox.classList.remove('opacity-0', 'scale-95');
                  }, 100);
                };
              }
            } catch (error) {
              console.error('轮询过程中发生错误:', error);
            }
          }
        if (!ready) {
          throw new Error('在预设时间内未获取到生成结果，请稍后在“历史记录”中查看或重试');
        }

      } catch (error) {
        const msg = error.name === 'AbortError' 
          ? '客户端等待超时（>120秒）。请检查 ComfyUI 是否运行、工作流是否有图片输出或尝试重试。' 
          : (error.message || '生成失败，请重试');
        alert(msg);
        loadingPlaceholder.classList.add('hidden');
        resultBox.classList.add('hidden');
      } finally {
        // 恢复按钮状态
        genBtn.disabled = false;
        genBtn.innerHTML = '<span>立即生成设计图</span><i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>';
      }
    });

    // 添加输入框抖动动画样式
    const style = document.createElement('style');
    style.textContent = `
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
        20%, 40%, 60%, 80% { transform: translateX(3px); }
      }
      .animate-shake {
        animation: shake 0.5s ease-in-out;
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
