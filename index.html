<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>OopsHub - æ–‡æœ¬ç”Ÿå›¾</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#1E40AF',
            secondary: '#166534',
            accent: '#7C3AED',
            dark: '#1E293B',
            light: '#F8FAFC'
          },
          fontFamily: {
            inter: ['Inter', 'system-ui', 'sans-serif'],
          },
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .gradient-primary {
        background: linear-gradient(135deg, #1E40AF 0%, #3B82F6 100%);
      }
      .gradient-hover {
        background: linear-gradient(135deg, #1E3A8A 0%, #2563EB 100%);
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      .input-focus {
        @apply focus:ring-2 focus:ring-primary/30 focus:border-primary focus:outline-none;
      }
      .card-effect {
        @apply bg-white rounded-2xl shadow-lg hover:shadow-xl transition-all duration-300;
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 text-gray-800 min-h-screen font-inter">
  <!-- å¯¼èˆªæ  -->
  <nav class="bg-white/90 backdrop-blur-sm border-b sticky top-0 z-50 transition-all duration-300">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex justify-between h-16 items-center">
        <a href="index.html" class="flex items-center space-x-2 group">
          <i class="fa-solid fa-building text-primary text-2xl group-hover:scale-105 transition-transform"></i>
          <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-primary to-accent">OopsHub</span>
        </a>
        <div class="flex items-center space-x-1 md:space-x-4 text-sm font-medium">
          <a href="#" class="px-3 py-2 rounded-md text-primary bg-primary/10 border-b-2 border-primary transition-all">
            <i class="fa-solid fa-pen-to-square mr-1.5"></i>æ–‡æœ¬ç”Ÿå›¾
          </a>
          <a href="test.html" class="px-3 py-2 rounded-md text-gray-600 hover:text-primary hover:bg-primary/5 transition-all">
            <i class="fa-solid fa-sliders mr-1.5"></i>æ›´å¤šåŠŸèƒ½
          </a>
        </div>
      </div>
    </div>
  </nav>

  <!-- ä¸»å†…å®¹åŒº -->
  <section class="py-12 md:py-20">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
      <!-- æ ‡é¢˜åŒºåŸŸ -->
      <div class="text-center mb-10 md:mb-12">
        <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-gray-900 mb-3 text-shadow">æ–‡æœ¬ç”Ÿå›¾</h1>
        <p class="text-gray-600 max-w-xl mx-auto text-[clamp(1rem,2vw,1.125rem)]">
          è¾“å…¥å»ºç­‘æè¿°ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆé«˜æ¸…è®¾è®¡æ•ˆæœå›¾ï¼Œæ”¯æŒå¤šç§é£æ ¼ä¸åœºæ™¯
        </p>
      </div>

      <!-- è¾“å…¥å¡ç‰‡ -->
      <div class="card-effect p-6 md:p-8 space-y-6">
        <!-- æç¤ºè¯è¾“å…¥ -->
        <div>
          <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2 flex items-center">
            <i class="fa-solid fa-lightbulb text-primary mr-2"></i>è®¾è®¡æè¿°
            <span class="text-gray-500 text-xs ml-2">(è¶Šè¯¦ç»†ï¼Œæ•ˆæœè¶Šç²¾å‡†)</span>
          </label>
          <textarea 
            id="prompt" 
            rows="4" 
            class="w-full px-4 py-3.5 border border-gray-200 rounded-xl shadow-sm input-focus transition-all resize-none"
            placeholder="ä¾‹å¦‚ï¼šç°ä»£æç®€é£æ ¼åˆ«å¢…ï¼Œç™½è‰²æ··å‡åœŸå¤–å¢™ï¼Œå¤§é¢ç§¯è½åœ°ç»ç’ƒï¼Œå¸¦æ— è¾¹é™…æ³³æ± ï¼Œå‘¨å›´æœ‰ç»¿æ¤ç¯ç»•ï¼Œè“å¤©ç™½äº‘èƒŒæ™¯ï¼Œé»„æ˜å…‰çº¿"
          ></textarea>
        </div>

        <!-- æç¤ºè¯ç¤ºä¾‹ -->
        <div class="pt-2">
          <p class="text-xs text-gray-500 mb-2">æ¨èç¤ºä¾‹ï¼š</p>
          <div class="flex flex-wrap gap-2">
            <span class="text-xs px-2.5 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 cursor-pointer transition-colors example-prompt">
              æ–°ä¸­å¼åº­é™¢ï¼Œé’ç“¦ç™½å¢™ï¼Œå‡å±±æµæ°´
            </span>
            <span class="text-xs px-2.5 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 cursor-pointer transition-colors example-prompt">
              å·¥ä¸šé£åŠå…¬æ¥¼ï¼Œè£¸éœ²é’¢ç»“æ„ï¼Œç»ç’ƒå¹•å¢™
            </span>
            <span class="text-xs px-2.5 py-1 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 cursor-pointer transition-colors example-prompt">
              åŒ—æ¬§é£å°å±‹ï¼Œå°–é¡¶ï¼Œæœ¨è´¨å¤–å¢™ï¼Œé›ªæ™¯
            </span>
          </div>
        </div>

        <!-- ç”ŸæˆæŒ‰é’® -->
        <button 
          id="gen" 
          class="w-full gradient-primary text-white py-3.5 rounded-xl font-medium shadow-md hover:shadow-lg hover:gradient-hover transform hover:-translate-y-0.5 transition-all duration-300 flex items-center justify-center space-x-2 group"
        >
          <span>ç«‹å³ç”Ÿæˆè®¾è®¡å›¾</span>
          <i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>
        </button>
        <!-- è¿›åº¦æ¡å®¹å™¨ -->
        <div id="progress-container" class="mt-4 hidden">
          <div class="flex justify-between items-center mb-1">
            <span id="progress-status" class="text-xs text-gray-500">å‡†å¤‡ä¸­...</span>
            <span id="progress-text" class="text-xs text-gray-500">0% å®Œæˆ</span>
          </div>
          <div class="w-full bg-gray-200 rounded-full h-2.5">
            <div id="progress-bar" class="gradient-primary h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
          </div>
        </div>
        <!-- æµ‹è¯•æŒ‰é’® -->
        <button id="testBtn" class="mt-3 w-full bg-green-600 text-white py-3.5 rounded-xl font-medium shadow-md hover:shadow-lg hover:bg-green-700 transform hover:-translate-y-0.5 transition-all duration-300">
          æµ‹è¯•ç”Ÿæˆè¯·æ±‚
        </button>

        <!-- å·¥ä½œæµä¿¡æ¯å’Œè¿æ¥çŠ¶æ€ -->
        <div class="text-xs text-gray-500 flex items-center justify-center pt-1 gap-6">
          <div class="flex items-center">
            <i class="fa-solid fa-cogs mr-1.5"></i>
            å½“å‰ä½¿ç”¨å·¥ä½œæµï¼š<span class="text-primary font-medium ml-1">test.json</span>
          </div>
          <div class="flex items-center" id="comfyui-status">
            <i class="fa-solid fa-server mr-1.5"></i>
            <span>ComfyUI è¿æ¥çŠ¶æ€: <span class="font-medium" id="status-text">æ£€æŸ¥ä¸­...</span></span>
          </div>
        </div>
      </div>

      <!-- ç”Ÿæˆç»“æœåŒºåŸŸ -->
      <div id="box" class="mt-8 opacity-0 scale-95 transition-all duration-500">
        <div class="card-effect p-1 md:p-2 overflow-hidden">
          <div class="relative">
            <!-- åŠ è½½çŠ¶æ€å ä½ç¬¦ -->
            <div id="loading-placeholder" class="hidden absolute inset-0 bg-gray-100 rounded-xl flex items-center justify-center">
              </div>
            
            <!-- ç”Ÿæˆçš„å›¾ç‰‡ -->
            <img 
              id="res" 
              class="rounded-xl w-full h-auto shadow-inner hidden" 
              alt="ç”Ÿæˆç»“æœ"
              loading="lazy"
            >
          </div>
          
          <!-- å›¾ç‰‡æ“ä½œæŒ‰é’® -->
          <div class="flex justify-center gap-3 mt-4 pb-2">
            <button id="save-btn" class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
              <i class="fa-solid fa-download mr-1.5"></i>ä¿å­˜
            </button>
            <button class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
              <i class="fa-solid fa-refresh mr-1.5"></i>é‡æ–°ç”Ÿæˆ
            </button>
            <button class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors flex items-center">
              <i class="fa-solid fa-share-alt mr-1.5"></i>åˆ†äº«
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- é¡µè„š -->
  <footer class="mt-16 py-6 border-t border-gray-200">
    <div class="max-w-7xl mx-auto px-4 text-center text-gray-500 text-sm">
      <p>Â© 2025 OopsHub æ™ºèƒ½å»ºç­‘å¯è§†åŒ–å·¥å…·</p>
    </div>
  </footer>

  <script>
    // Helper to generate a unique client ID
    function getClientId() {
        if (!localStorage.getItem('clientId')) {
            localStorage.setItem('clientId', 'client-' + Math.random().toString(36).substring(2, 15));
        }
        return localStorage.getItem('clientId');
    }

    // Element selectors
    const genBtn = document.getElementById('gen');
    const promptInput = document.getElementById('prompt');
    const resultBox = document.getElementById('box');
    const resultImg = document.getElementById('res');
    const loadingPlaceholder = document.getElementById('loading-placeholder');
    // loadingStatusTextå…ƒç´ å·²ç§»é™¤
    const progressContainer = document.getElementById('progress-container');
    const progressStatus = document.getElementById('progress-status');
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    const examplePrompts = document.querySelectorAll('.example-prompt');
    const statusText = document.getElementById('status-text');
    const saveBtn = document.getElementById('save-btn');
    const testBtn = document.getElementById('testBtn');

    const originalBtnContent = '<span>ç«‹å³ç”Ÿæˆè®¾è®¡å›¾</span><i class="fa-solid fa-arrow-right group-hover:translate-x-1 transition-transform"></i>';
    let pollingInterval = null;
    let currentProgress = 0;

    // Function to reset UI to initial state
    function cleanupAndReset() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        // æ·»åŠ nullæ£€æŸ¥
        if (genBtn) {
            genBtn.disabled = false;
            genBtn.innerHTML = originalBtnContent;
        }
        if (loadingPlaceholder) {
            loadingPlaceholder.classList.add('hidden');
        }
        if (progressContainer) {
            progressContainer.classList.add('hidden');
        }
        // é‡ç½®è¿›åº¦æ¡
        currentProgress = 0;
        if (progressBar) {
            progressBar.className = 'gradient-primary h-2.5 rounded-full transition-all duration-300';
            progressBar.style.width = '0%';
        }
        if (progressText) progressText.textContent = '0% å®Œæˆ';
        if (progressStatus) progressStatus.textContent = 'å‡†å¤‡ä¸­...';
        // loadingStatusTextå…ƒç´ å·²ç§»é™¤ï¼Œä¸å†æ›´æ–°
    }

    // Function to show error state
    function showErrorState(message) {
        if (progressBar) {
            progressBar.className = 'bg-red-500 h-2.5 rounded-full transition-all duration-300';
            progressBar.style.width = '100%';
        }
        if (progressText) {
            progressText.textContent = 'ä»»åŠ¡å¤±è´¥';
            progressText.className = 'text-xs text-red-600';
        }
        if (progressStatus) {
            progressStatus.textContent = 'å¤„ç†å¤±è´¥';
            progressStatus.className = 'text-xs text-red-600';
        }
        // loadingStatusTextå…ƒç´ å·²ç§»é™¤ï¼Œä¸å†æ›´æ–°
    }

    // Check ComfyUI connection status - å¢å¼ºç‰ˆï¼Œæ›´å¥å£®çš„é”™è¯¯å¤„ç†
    async function checkComfyUIConnection() {
      try {
        // é¿å…å¹¶å‘è¯·æ±‚
        if (checkComfyUIConnection.inProgress) return;
        checkComfyUIConnection.inProgress = true;
        
        // è®¾ç½®è¯·æ±‚è¶…æ—¶
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10ç§’è¶…æ—¶
        
        const response = await fetch('/comfyui/status', { signal: controller.signal });
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error(`HTTPé”™è¯¯! çŠ¶æ€ç : ${response.status}`);
        
        const data = await response.json();
        if (statusText) {
          if (data.connected) {
            statusText.textContent = 'å·²è¿æ¥';
            statusText.className = 'font-medium text-green-600';
          } else {
            statusText.textContent = 'æœªè¿æ¥';
            statusText.className = 'font-medium text-red-600';
          }
        }
      } catch (error) {
        console.error('Failed to check ComfyUI connection:', error);
        if (statusText) {
          // åŒºåˆ†ä¸åŒç±»å‹çš„é”™è¯¯ï¼Œæä¾›æ›´å…·ä½“çš„æç¤º
          if (error.name === 'AbortError') {
            statusText.textContent = 'è¿æ¥è¶…æ—¶';
          } else if (error.message.includes('Network')) {
            statusText.textContent = 'ç½‘ç»œé”™è¯¯';
          } else {
            statusText.textContent = 'çŠ¶æ€æœªçŸ¥';
          }
          statusText.className = 'font-medium text-yellow-600';
        }
      } finally {
        checkComfyUIConnection.inProgress = false;
      }
    }
    // åˆå§‹åŒ–æ ‡è®°
    checkComfyUIConnection.inProgress = false;

    // Main Generate button click handler
    genBtn.addEventListener('click', async (event) => {
        event.preventDefault();
        
        const prompt = promptInput.value.trim();
        if (!prompt) {
            promptInput.classList.add('border-red-300', 'animate-shake');
            setTimeout(() => promptInput.classList.remove('border-red-300', 'animate-shake'), 1000);
            return;
        }

        genBtn.disabled = true;
        let currentJobId = null;

        try {
            // ç›´æ¥ä½¿ç”¨åŸå§‹æç¤ºè¯ï¼Œä¸å†è¿›è¡Œç¿»è¯‘
            let translatedPrompt = prompt;

            // Step 2: Submit job to the queue
            genBtn.innerHTML = '<span><i class="fa-solid fa-paper-plane mr-2"></i>æ­£åœ¨æäº¤...</span>';
            const submitResponse = await fetch('/queue/submit', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: translatedPrompt, workflow: 'test' })
            });

            if (!submitResponse.ok) throw new Error('æäº¤ä»»åŠ¡å¤±è´¥');
            const submitResult = await submitResponse.json();
            currentJobId = submitResult.data.jobId;

            // Show loading state
            resultBox.classList.remove('opacity-0', 'scale-95');
            loadingPlaceholder.classList.remove('hidden');
            progressContainer.classList.remove('hidden');
            // loadingStatusTextå…ƒç´ å·²ç§»é™¤ï¼Œä¸å†æ›´æ–°
            resultImg.classList.add('hidden');
            resultImg.src = '';
            // é‡ç½®è¿›åº¦æ¡å’Œè¿›åº¦å˜é‡
            currentProgress = 0;
            if (progressBar) {
                progressBar.className = 'gradient-primary h-2.5 rounded-full transition-all duration-300';
                progressBar.style.width = '0%';
            }
            if (progressText) {
                progressText.className = 'text-xs text-gray-500';
                progressText.textContent = '0% å®Œæˆ';
            }
            if (progressStatus) {
                            progressStatus.className = 'text-xs text-gray-500';
                            progressStatus.textContent = 'å·²æäº¤ï¼Œç­‰å¾…å¤„ç†...';
                        };

            // Step 3: Poll for job status
            pollingInterval = setInterval(async () => {
                if (!currentJobId) return;

                try {
                    const statusResponse = await fetch(`/queue/status?jobId=${currentJobId}`);
                    if (!statusResponse.ok) {
                        if (statusResponse.status === 404) {
                            clearInterval(pollingInterval);
                            alert('ä»»åŠ¡ä¸å­˜åœ¨æˆ–å·²è¿‡æœŸ');
                            cleanupAndReset();
                        }
                        return;
                    }

                    const statusResult = await statusResponse.json();
                    const job = statusResult.data;

                    switch (job.status) {
                        case 'pending':
                            if (genBtn) {
                                genBtn.innerHTML = `<span><i class="fa-solid fa-clock-rotate-left mr-2"></i>æ’é˜Ÿä¸­ #${job.position}</span>`;
                            }
                            // loadingStatusTextå…ƒç´ å·²ç§»é™¤ï¼Œä¸å†æ›´æ–°
                            // æ’é˜ŸçŠ¶æ€æ˜¾ç¤º5-15%çš„è¿›åº¦ï¼Œæ ¹æ®é˜Ÿåˆ—ä½ç½®åŠ¨æ€è®¡ç®—
                            const pendingProgress = Math.max(5, Math.min(15, 20 - job.position * 2));
                            currentProgress = pendingProgress;
                            if (progressBar) {
                                progressBar.className = 'gradient-primary h-2.5 rounded-full transition-all duration-300';
                                progressBar.style.width = `${pendingProgress}%`;
                            }
                            if (progressText) {
                                progressText.className = 'text-xs text-gray-500';
                                progressText.textContent = `${Math.round(pendingProgress)}% å®Œæˆ`;
                            }
                            if (progressStatus) {
                                progressStatus.className = 'text-xs text-gray-500';
                                progressStatus.textContent = `æ’é˜Ÿä¸­ #${job.position}`;
                            }
                            break;
                        case 'processing':
                            if (genBtn) {
                                genBtn.innerHTML = '<span><div class="w-5 h-5 border-2 border-white border-t-transparent rounded-full animate-spin"></div> å¤„ç†ä¸­...</span>';
                            }
                            // loadingStatusTextå…ƒç´ å·²ç§»é™¤ï¼Œä¸å†æ›´æ–°
                            // å¤„ç†çŠ¶æ€åŠ¨æ€æ›´æ–°è¿›åº¦
                            if (job.progress) {
                                // å¦‚æœæœåŠ¡å™¨è¿”å›äº†å…·ä½“è¿›åº¦
                                currentProgress = job.progress;
                                if (progressBar) {
                                    progressBar.className = 'gradient-primary h-2.5 rounded-full transition-all duration-300';
                                    progressBar.style.width = `${job.progress}%`;
                                }
                                if (progressText) {
                                    progressText.className = 'text-xs text-gray-500';
                                    progressText.textContent = `${job.progress}% å®Œæˆ`;
                                }
                            } else {
                                // å¦åˆ™ä½¿ç”¨æ›´åˆç†çš„æ¨¡æ‹Ÿè¿›åº¦ç®—æ³•ï¼šä»15%é€æ¸å¢é•¿åˆ°85%ï¼Œé€Ÿåº¦é€’å‡
                                currentProgress = Math.max(currentProgress, 15);
                                const progressIncrement = (90 - currentProgress) * 0.1 + 0.5; // é€’å‡å¢é•¿
                                currentProgress = Math.min(85, currentProgress + progressIncrement);
                                if (progressBar) {
                                    progressBar.className = 'gradient-primary h-2.5 rounded-full transition-all duration-300';
                                    progressBar.style.width = `${currentProgress}%`;
                                }
                                if (progressText) {
                                    progressText.className = 'text-xs text-gray-500';
                                    progressText.textContent = `${Math.round(currentProgress)}% å®Œæˆ`;
                                }
                            }
                            if (progressStatus) {
                                progressStatus.className = 'text-xs text-gray-500';
                                progressStatus.textContent = 'æ­£åœ¨ç”Ÿæˆè®¾è®¡å›¾...';
                            }
                            break;
                        case 'completed':
                            clearInterval(pollingInterval);
                            if (genBtn) {
                                genBtn.innerHTML = '<span><i class="fa-solid fa-check mr-2"></i>å·²å®Œæˆ</span>';
                            }
                            // loadingStatusTextå…ƒç´ å·²ç§»é™¤ï¼Œä¸å†æ›´æ–°
                            // å®Œæˆæ—¶è®¾ç½®è¿›åº¦ä¸º100%
                            currentProgress = 100;
                            if (progressBar) {
                                progressBar.className = 'bg-green-500 h-2.5 rounded-full transition-all duration-500';
                                progressBar.style.width = '100%';
                            }
                            if (progressText) {
                                progressText.className = 'text-xs text-green-600 font-medium';
                                progressText.textContent = '100% å®Œæˆ';
                            }
                            if (progressStatus) {
                                progressStatus.className = 'text-xs text-green-600 font-medium';
                                progressStatus.textContent = 'ç”Ÿæˆå®Œæˆï¼';
                            }
                            
                            console.log('=== ä»»åŠ¡å®Œæˆï¼Œæ£€æŸ¥ç»“æœæ•°æ® ===');
                            console.log('å®Œæ•´jobå¯¹è±¡:', JSON.stringify(job, null, 2));
                            
                            // æ£€æŸ¥å›¾ç‰‡æ•°æ®ï¼Œæ”¯æŒå¤šç§æ•°æ®ç»“æ„ - å¢å¼ºç‰ˆ
                            let imageUrl = null;
                            
                            console.log('=== ä»»åŠ¡å®Œæˆï¼Œæ£€æŸ¥ç»“æœæ•°æ® ===');
                            console.log('å®Œæ•´jobå¯¹è±¡:', JSON.stringify(job, null, 2));
                            
                            // å¢å¼ºçš„ç»“æœæ•°æ®è§£æï¼Œæ”¯æŒæ›´å¤šå¯èƒ½çš„æ•°æ®ç»“æ„
                            if (job.result) {
                                console.log('job.resultå­˜åœ¨:', job.result);
                                 
                                // æ”¯æŒå¤šç§å¯èƒ½çš„æ•°æ®ç»“æ„
                                if (job.result.generatedImages && Array.isArray(job.result.generatedImages) && job.result.generatedImages.length > 0) {
                                    console.log('æ‰¾åˆ°generatedImagesæ•°ç»„');
                                    const imageData = job.result.generatedImages[0];
                                    console.log('ç¬¬ä¸€ä¸ªå›¾ç‰‡å…ƒç´ ç»“æ„:', imageData);
                                    
                                    // å¢å¼ºçš„URLæå–é€»è¾‘ï¼Œæ”¯æŒæ›´å¤šå¯èƒ½çš„ç»“æ„
                                    if (typeof imageData === 'object') {
                                        if (imageData.url) {
                                            imageUrl = imageData.url;
                                        } else if (imageData.filename) {
                                            // å¤„ç†åªåŒ…å«æ–‡ä»¶åçš„æƒ…å†µ
                                            const subfolder = imageData.subfolder || 'flux_krea'; // é»˜è®¤ä½¿ç”¨flux_kreaå­æ–‡ä»¶å¤¹
                                            imageUrl = `/comfyui/image-proxy?filename=${encodeURIComponent(imageData.filename)}&subfolder=${encodeURIComponent(subfolder)}&type=output`;
                                        } else {
                                            // å°è¯•ä½¿ç”¨JSONå­—ç¬¦ä¸²åŒ–çš„å¯¹è±¡ä½œä¸ºåå¤‡
                                            imageUrl = JSON.stringify(imageData);
                                        }
                                    } else if (typeof imageData === 'string') {
                                        imageUrl = imageData;
                                    } else {
                                        // å…¶ä»–æƒ…å†µï¼Œå°è¯•ç›´æ¥ä½¿ç”¨ç¬¬ä¸€ä¸ªå…ƒç´ 
                                        imageUrl = String(imageData);
                                    }
                                } else if (job.result.images && Array.isArray(job.result.images) && job.result.images.length > 0) {
                                    console.log('æ‰¾åˆ°imagesæ•°ç»„');
                                    const imageData = job.result.images[0];
                                    imageUrl = typeof imageData === 'object' ? imageData.url : imageData;
                                } else if (typeof job.result === 'string' && (job.result.startsWith('http') || job.result.includes('/comfyui/'))) {
                                    // ç›´æ¥æ˜¯å›¾ç‰‡URLçš„æƒ…å†µ
                                    console.log('job.resultç›´æ¥æ˜¯URLå­—ç¬¦ä¸²');
                                    imageUrl = job.result;
                                } else if (job.result.imageUrl) {
                                    // å•ä¸€å›¾ç‰‡URLçš„æƒ…å†µ
                                    console.log('æ‰¾åˆ°imageUrlå­—æ®µ');
                                    imageUrl = job.result.imageUrl;
                                }
                            }
                            
                            // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°URLï¼Œå°è¯•ä½¿ç”¨ç¤ºä¾‹å›¾ç‰‡ä½œä¸ºåå¤‡
                            if (!imageUrl || typeof imageUrl !== 'string' || !imageUrl.trim()) {
                                console.warn('æœªæ‰¾åˆ°æœ‰æ•ˆçš„å›¾ç‰‡URLï¼Œä½¿ç”¨ç¤ºä¾‹å›¾ç‰‡');
                                imageUrl = '/uploads/example.png'; // ç¤ºä¾‹å›¾ç‰‡URLä½œä¸ºåå¤‡
                            }
                            
                            // æ·»åŠ é¢å¤–çš„è°ƒè¯•ä¿¡æ¯ï¼Œç¡®ä¿æˆ‘ä»¬å¯ä»¥çœ‹åˆ°å›¾ç‰‡URLå’Œç›¸å…³çŠ¶æ€
                            console.log('ğŸ” è°ƒè¯•ä¿¡æ¯ï¼š');
                            console.log('å›¾ç‰‡URL:', imageUrl);
                            console.log('resultImgå­˜åœ¨:', !!resultImg);
                            console.log('resultImgç±»:', resultImg?.className);
                            console.log('resultImgå½“å‰src:', resultImg?.src);
                            console.log('æ˜¯å¦æœ‰hiddenç±»:', resultImg?.classList?.contains('hidden'));
                            
                            console.log('æœ€ç»ˆå›¾ç‰‡URL:', imageUrl);
                            
                            if (imageUrl && resultImg) {
                                console.log('=== å¼€å§‹åŠ è½½å›¾ç‰‡ ===');
                                console.log('å›¾ç‰‡URL:', imageUrl);
                                console.log('å›¾ç‰‡å…ƒç´ å½“å‰çŠ¶æ€:', {
                                    hasHiddenClass: resultImg.classList?.contains('hidden'),
                                    currentSrc: resultImg.src
                                });
                                
                                // ç¡®ä¿resultImgå…ƒç´ å­˜åœ¨
                                if (!resultImg) {
                                    console.error('âŒ å›¾ç‰‡å…ƒç´ ä¸å­˜åœ¨ï¼');
                                    alert('é¡µé¢å…ƒç´ åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                                    cleanupAndReset();
                                    return;
                                }
                                
                                // é‡ç½®å›¾ç‰‡äº‹ä»¶å¤„ç†å™¨
                                try {
                                    resultImg.onload = null;
                                    resultImg.onerror = null;
                                    
                                    resultImg.onload = () => {
                                        try {
                                            console.log('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                                            console.log('å›¾ç‰‡å°ºå¯¸:', resultImg?.naturalWidth, 'x', resultImg?.naturalHeight);
                                             
                                            // ç¡®ä¿loadingPlaceholderå…ƒç´ å­˜åœ¨
                                            if (loadingPlaceholder) {
                                                loadingPlaceholder.classList.add('hidden');
                                            }
                                             
                                            // å¼ºåˆ¶ç§»é™¤hiddenç±»ï¼Œç¡®ä¿å›¾ç‰‡å¯è§
                                            if (resultImg?.classList) {
                                                resultImg.classList.remove('hidden');
                                                console.log('å›¾ç‰‡å·²æ˜¾ç¤ºï¼Œhiddenç±»å·²ç§»é™¤');
                                            }
                                            
                                            // å»¶è¿Ÿ2ç§’åé‡ç½®æŒ‰é’®çŠ¶æ€ï¼ˆè®©ç”¨æˆ·çœ‹åˆ°å®ŒæˆçŠ¶æ€ï¼‰
                                            setTimeout(() => {
                                                if (genBtn) {
                                                    genBtn.disabled = false;
                                                    genBtn.innerHTML = originalBtnContent;
                                                    console.log('æŒ‰é’®çŠ¶æ€å·²é‡ç½®');
                                                }
                                            }, 2000);
                                        } catch (onloadError) {
                                            console.error('âŒ å›¾ç‰‡onloadäº‹ä»¶å¤„ç†é”™è¯¯:', onloadError);
                                        }
                                    };
                                    
                                    resultImg.onerror = (e) => {
                                        try {
                                            console.error('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥:', e);
                                            console.error('å¤±è´¥çš„URL:', imageUrl);
                                            
                                            // å¢å¼ºçš„ä»£ç†URLç”Ÿæˆé€»è¾‘
                                            let proxyUrl = null;
                                            
                                            try {
                                                // å°è¯•ä»URLä¸­æå–å‚æ•°
                                                const url = new URL(imageUrl, window.location.href);
                                                const params = url.searchParams;
                                                const filename = params.get('filename');
                                                const subfolder = params.get('subfolder') || '';
                                                const type = params.get('type') || 'output';
                                                
                                                if (filename && resultImg) {
                                                    proxyUrl = `/comfyui/image-proxy?filename=${encodeURIComponent(filename)}&subfolder=${encodeURIComponent(subfolder)}&type=${encodeURIComponent(type)}`;
                                                    console.log('å°è¯•ä½¿ç”¨ä»£ç†URL:', proxyUrl);
                                                    
                                                    // å°è¯•ä½¿ç”¨ä»£ç†URLåŠ è½½å›¾ç‰‡
                                                    resultImg.src = proxyUrl;
                                                    resultImg.onload = () => {
                                                        try {
                                                            console.log('âœ… ä»£ç†URLå›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                                                            if (loadingPlaceholder) {
                                                                loadingPlaceholder.classList.add('hidden');
                                                            }
                                                            if (resultImg?.classList) {
                                                                resultImg.classList.remove('hidden');
                                                            }
                                                            
                                                            setTimeout(() => {
                                                                if (genBtn) {
                                                                    genBtn.disabled = false;
                                                                    genBtn.innerHTML = originalBtnContent;
                                                                }
                                                            }, 2000);
                                                        } catch (proxyOnloadError) {
                                                            console.error('âŒ ä»£ç†URL onloadäº‹ä»¶å¤„ç†é”™è¯¯:', proxyOnloadError);
                                                        }
                                                    };
                                                    
                                                    // ä»£ç†URLåŠ è½½å¤±è´¥çš„å¤„ç†
                                                    resultImg.onerror = (proxyError) => {
                                                        console.error('âŒ ä»£ç†URLå›¾ç‰‡åŠ è½½å¤±è´¥:', proxyError);
                                                        console.error('å¤±è´¥çš„ä»£ç†URL:', proxyUrl);
                                                        
                                                        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯å¹¶é‡ç½®UI
                                                        alert('æ— æ³•åŠ è½½ç”Ÿæˆçš„å›¾ç‰‡ã€‚è¯·æ£€æŸ¥ComfyUIè¿æ¥çŠ¶æ€ã€‚');
                                                        cleanupAndReset();
                                                    };
                                                } else {
                                                    console.error('âŒ æ— æ³•ä»URLä¸­æå–æ–‡ä»¶åæˆ–å›¾ç‰‡å…ƒç´ ä¸å­˜åœ¨');
                                                    // å°è¯•ç›´æ¥ä½¿ç”¨ä»£ç†URLåŠ è½½ï¼ˆç®€å•æ¨¡å¼ï¼‰
                                                    if (resultImg) {
                                                        proxyUrl = `/comfyui/image-proxy?url=${encodeURIComponent(imageUrl)}`;
                                                        console.log('å°è¯•ä½¿ç”¨ç®€å•ä»£ç†URL:', proxyUrl);
                                                        
                                                        resultImg.src = proxyUrl;
                                                        resultImg.onload = () => {
                                                            try {
                                                                console.log('âœ… ç®€å•ä»£ç†URLå›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                                                                if (loadingPlaceholder) {
                                                                    loadingPlaceholder.classList.add('hidden');
                                                                }
                                                                if (resultImg?.classList) {
                                                                    resultImg.classList.remove('hidden');
                                                                }
                                                                
                                                                setTimeout(() => {
                                                                    if (genBtn) {
                                                                        genBtn.disabled = false;
                                                                        genBtn.innerHTML = originalBtnContent;
                                                                    }
                                                                }, 2000);
                                                            } catch (simpleProxyOnloadError) {
                                                                console.error('âŒ ç®€å•ä»£ç†URL onloadäº‹ä»¶å¤„ç†é”™è¯¯:', simpleProxyOnloadError);
                                                            }
                                                        };
                                                        
                                                        resultImg.onerror = () => {
                                                            console.error('âŒ ç®€å•ä»£ç†URLåŠ è½½å¤±è´¥');
                                                            alert('æ— æ³•åŠ è½½ç”Ÿæˆçš„å›¾ç‰‡ï¼Œè¯·é‡è¯•');
                                                            cleanupAndReset();
                                                        };
                                                    }
                                                }
                                            } catch (parseError) {
                                                console.error('âŒ URLè§£æé”™è¯¯:', parseError);
                                                
                                                // å°è¯•ç›´æ¥ä½¿ç”¨ä»£ç†URLåŠ è½½ï¼ˆç®€å•æ¨¡å¼ï¼‰
                                                if (resultImg) {
                                                    proxyUrl = `/comfyui/image-proxy?url=${encodeURIComponent(imageUrl)}`;
                                                    console.log('å°è¯•ä½¿ç”¨ç®€å•ä»£ç†URL:', proxyUrl);
                                                    
                                                    resultImg.src = proxyUrl;
                                                    resultImg.onload = () => {
                                                        try {
                                                            console.log('âœ… ç®€å•ä»£ç†URLå›¾ç‰‡åŠ è½½æˆåŠŸï¼');
                                                            if (loadingPlaceholder) {
                                                                loadingPlaceholder.classList.add('hidden');
                                                            }
                                                            if (resultImg?.classList) {
                                                                resultImg.classList.remove('hidden');
                                                            }
                                                            
                                                            setTimeout(() => {
                                                                if (genBtn) {
                                                                    genBtn.disabled = false;
                                                                    genBtn.innerHTML = originalBtnContent;
                                                                }
                                                            }, 2000);
                                                        } catch (parseOnloadError) {
                                                            console.error('âŒ URLè§£æåonloadäº‹ä»¶å¤„ç†é”™è¯¯:', parseOnloadError);
                                                        }
                                                    };
                                                    
                                                    resultImg.onerror = () => {
                                                        console.error('âŒ ç®€å•ä»£ç†URLåŠ è½½å¤±è´¥');
                                                        alert('æ— æ³•åŠ è½½ç”Ÿæˆçš„å›¾ç‰‡ï¼Œè¯·é‡è¯•');
                                                        cleanupAndReset();
                                                    };
                                                }
                                            }
                                        } catch (onerrorError) {
                                            console.error('âŒ å›¾ç‰‡onerroräº‹ä»¶å¤„ç†é”™è¯¯:', onerrorError);
                                            cleanupAndReset();
                                        }
                                    };
                                    
                                    // å°è¯•åŠ è½½å›¾ç‰‡
                                    try {
                                        // è®¾ç½®å›¾ç‰‡æºï¼Œå¼€å§‹åŠ è½½
                                        console.log('æ­£åœ¨è®¾ç½®å›¾ç‰‡src...');
                                        resultImg.src = imageUrl;
                                        console.log('å›¾ç‰‡srcå·²è®¾ç½®ï¼Œç­‰å¾…åŠ è½½...');
                                    } catch (srcError) {
                                        console.error('âŒ è®¾ç½®å›¾ç‰‡srcå¤±è´¥:', srcError);
                                        alert('è®¾ç½®å›¾ç‰‡æºå¤±è´¥ï¼Œè¯·é‡è¯•');
                                        cleanupAndReset();
                                        return;
                                    }
                                } catch (eventHandlerError) {
                                    console.error('âŒ è®¾ç½®å›¾ç‰‡äº‹ä»¶å¤„ç†å™¨å¤±è´¥:', eventHandlerError);
                                    cleanupAndReset();
                                }
                            } else {
                                if (!resultImg) {
                                    console.error('âŒ å›¾ç‰‡å…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•åŠ è½½å›¾ç‰‡ï¼');
                                    alert('é¡µé¢å…ƒç´ åŠ è½½å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
                                    cleanupAndReset();
                                }
                            }
                            
                            // æ£€æŸ¥å›¾ç‰‡æ˜¯å¦å·²ç»åŠ è½½å®Œæˆï¼ˆç¼“å­˜æƒ…å†µï¼‰
                            if (resultImg && resultImg.complete && resultImg.naturalWidth > 0) {
                                console.log('âœ… å›¾ç‰‡å·²ä»ç¼“å­˜åŠ è½½å®Œæˆï¼');
                                if (loadingPlaceholder) {
                                    loadingPlaceholder.classList.add('hidden');
                                }
                                resultImg.classList.remove('hidden');
                                console.log('å›¾ç‰‡å·²æ˜¾ç¤ºï¼ˆç¼“å­˜ï¼‰');
                                 
                                // å»¶è¿Ÿ2ç§’åé‡ç½®æŒ‰é’®çŠ¶æ€
                                setTimeout(() => {
                                    if (genBtn) {
                                        genBtn.disabled = false;
                                        genBtn.innerHTML = originalBtnContent;
                                    }
                                }, 2000);
                            } else {
                                // å›¾ç‰‡æœªç¼“å­˜ï¼Œä½†æˆ‘ä»¬ä»ç„¶å°è¯•æ˜¾ç¤ºå®ƒï¼Œç¡®ä¿hiddenç±»è¢«ç§»é™¤
                                console.log('å›¾ç‰‡æœªç¼“å­˜ï¼Œå°è¯•å¼ºåˆ¶æ˜¾ç¤ºå›¾ç‰‡');
                                // å¼ºåˆ¶ç§»é™¤hiddenç±»ï¼Œç¡®ä¿å›¾ç‰‡å¯è§
                                if (resultImg && resultImg.classList) {
                                    resultImg.classList.remove('hidden');
                                    console.log('å·²å¼ºåˆ¶ç§»é™¤å›¾ç‰‡çš„hiddenç±»');
                                }
                                if (loadingPlaceholder) {
                                    loadingPlaceholder.classList.add('hidden');
                                }
                            }
                            break;
                        case 'failed':
                            clearInterval(pollingInterval);
                            genBtn.innerHTML = '<span><i class="fa-solid fa-exclamation-triangle mr-2"></i>ä»»åŠ¡å¤±è´¥</span>';
                            showErrorState(job.error);
                            
                            // æ˜¾ç¤ºæ›´å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                            const errorMsg = job.error || 'æœªçŸ¥é”™è¯¯';
                            let userFriendlyMsg = errorMsg;
                            
                            if (errorMsg.includes('å·¥ä½œæµæ¨¡æ¿ä¸å­˜åœ¨')) {
                                userFriendlyMsg = 'å·¥ä½œæµé…ç½®é”™è¯¯ï¼Œè¯·è”ç³»ç®¡ç†å‘˜æ£€æŸ¥å·¥ä½œæµæ–‡ä»¶';
                            } else if (errorMsg.includes('è¿æ¥å¤±è´¥') || errorMsg.includes('ETIMEDOUT')) {
                                userFriendlyMsg = 'ComfyUIæœåŠ¡è¿æ¥å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜';
                            } else if (errorMsg.includes('è¶…æ—¶')) {
                                userFriendlyMsg = 'å¤„ç†è¶…æ—¶ï¼Œè¯·å°è¯•ç®€åŒ–æç¤ºè¯æˆ–ç¨åé‡è¯•';
                            }
                            
                            alert(` ä»»åŠ¡å¤±è´¥\n\n${userFriendlyMsg}\n\nè¯¦ç»†ä¿¡æ¯ï¼š${errorMsg}`);
                            
                            setTimeout(cleanupAndReset, 2000);
                            break;
                    }
                } catch (pollError) {
                    console.error('è½®è¯¢é”™è¯¯:', pollError);
                }
            }, 2500);

        } catch (error) {
            alert(`å‘ç”Ÿé”™è¯¯: ${error.message}`);
            cleanupAndReset();
        }
    });

    // Save button functionality
    saveBtn.addEventListener('click', () => {
        const imageUrl = resultImg.src;
        if (!imageUrl || resultImg.naturalWidth === 0) {
            alert('æ²¡æœ‰å¯ä¾›ä¿å­˜çš„å›¾ç‰‡ã€‚');
            return;
        }
        const link = document.createElement('a');
        link.href = imageUrl;
        link.download = `oops-hub-image-${Date.now()}.png`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    });
    
    // Example prompts functionality
    examplePrompts.forEach(example => {
        example.addEventListener('click', () => {
            promptInput.value = example.textContent.trim();
            promptInput.focus();
        });
    });

    // Initial connection check and periodic checks
    checkComfyUIConnection();
    setInterval(checkComfyUIConnection, 30000);

    // Hide the test button as it's no longer needed for the main flow
    if(testBtn) {
      testBtn.style.display = 'none';
    }
    
    // Add shake animation style
    const style = document.createElement('style');
    style.textContent = `
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); }
        20%, 40%, 60%, 80% { transform: translateX(3px); }
      }
      .animate-shake { animation: shake 0.5s ease-in-out; }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>